<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireClassroom - 管理后台</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --primary-color-dark: #357ABD;
            --success-color: #50e3c2;
            --danger-color: #e95e5e;
            --light-gray-color: #f7f9fc;
            --text-color: #333;
            --text-color-light: #666;
            --border-color: #e0e6ed;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-gray-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .header-title h1 {
            font-size: 24px;
            color: var(--text-color);
            margin: 0 0 5px 0;
        }

        .header-title p {
            font-size: 14px;
            color: var(--text-color-light);
            margin: 0;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .nav-tab {
            padding: 12px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color-light);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; /* Overlap with container border */
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .nav-tab:hover:not(.active) {
            color: var(--primary-color);
        }

        .card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .card-header h2 {
            font-size: 20px;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color-light);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 10px 22px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
        }
        .btn:last-child {
            margin-right: 0;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(74, 144, 226, 0.2);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #34c3a3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(80, 227, 194, 0.2);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #d44a4a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(233, 94, 94, 0.2);
        }
        
        .btn-secondary {
            background: #fff;
            color: var(--text-color-light);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: #f8f9fa;
            color: var(--text-color);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: none;
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .table td .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #e6f9f5;
            color: #0d6a53;
            border-color: #b3e6da;
        }

        .alert-error {
            background: #fdeeee;
            color: #9b2c2c;
            border-color: #f8c6c6;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }

        .schedule-cell {
            background: white;
            padding: 10px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .schedule-header {
            background: none;
            font-weight: 600;
            color: var(--text-color);
            border: none;
        }
        
        .schedule-time-header {
            white-space: pre;
        }

        .schedule-course {
            background: #e9f3fe;
            color: #357ABD;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #cce1f9;
        }

        .schedule-course:hover {
            background: #d4e7fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        
        .schedule-course small {
            font-size: 11px;
            color: #5a8dc5;
            margin-top: 4px;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 550px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            background-color: #f7f9fc;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <h1>FireClassroom 管理后台</h1>
                <p>管理课程信息、课表安排和系统配置</p>
            </div>
            <div class="header-actions">
                <a href="./" class="btn btn-secondary">返回教室</a>
                <button id="logout-btn" class="btn btn-danger">退出登录</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('courses')">课程管理</button>
            <button class="nav-tab" onclick="showTab('schedule')">课表管理</button>
            <button class="nav-tab" onclick="showTab('config')">系统配置</button>
        </div>

        <div id="alert" class="alert"></div>

        <!-- 课程管理 -->
        <div id="courses-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2>课程列表</h2>
                    <button class="btn btn-primary" onclick="openCourseEditModal()">添加新课程</button>
                </div>
                <table class="table" id="courses-table">
                    <thead>
                        <tr>
                            <th>课程代码</th>
                            <th>课程名称</th>
                            <th>授课教师</th>
                            <th>教室</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 课表管理 -->
        <div id="schedule-tab" class="tab-content">
            <div class="card">
                 <div class="card-header">
                    <h2>课表视图</h2>
                </div>
                <p style="margin-bottom: 20px; color: var(--text-color-light);">点击下面的课表单元格以添加、更新或删除课程安排。</p>
                <div id="schedule-grid" class="schedule-grid"></div>
            </div>
        </div>

        <!-- 系统配置 -->
        <div id="config-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>系统配置</h2>
                </div>
                <form id="config-form">
                    <div class="form-group">
                        <label for="config-school-name">学校名称</label>
                        <input type="text" id="config-school-name">
                    </div>
                    <div class="form-group">
                        <label for="config-semester">当前学期</label>
                        <input type="text" id="config-semester">
                    </div>
                    <button type="submit" class="btn btn-success">保存配置</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let courses = [];
        let schedule = [];
        let config = {};

        // 标签页切换
        function showTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'schedule') {
                loadScheduleGrid();
            }
        }

        // 显示提示信息
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // 加载数据
        async function loadData() {
            try {
                // 加载配置，这个接口不需要登录
                const configResponse = await fetch('./api/config');
                if (configResponse.status === 401) {
                    window.location.href = './login';
                    return;
                }
                config = await configResponse.json();

                // 加载课程
                const coursesResponse = await fetch('./api/courses');
                 if (coursesResponse.status === 401) {
                    window.location.href = './login';
                    return;
                }
                const coursesData = await coursesResponse.json();
                courses = coursesData.courses || [];
                
                // 加载课表
                const scheduleResponse = await fetch('./api/schedule');
                 if (scheduleResponse.status === 401) {
                    window.location.href = './login';
                    return;
                }
                const scheduleData = await scheduleResponse.json();
                schedule = scheduleData.schedule || [];
                
                updateUI();
            } catch (error) {
                console.error('加载数据失败:', error);
                showAlert('加载数据失败', 'error');
            }
        }

        // 更新界面
        function updateUI() {
            updateCoursesTable();
            updateConfigForm();
        }

        // 更新课程表格
        function updateCoursesTable() {
            const tbody = document.querySelector('#courses-table tbody');
            tbody.innerHTML = '';
            
            courses.forEach(course => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${course.id}</td>
                    <td>${course.name}</td>
                    <td>${course.teacher}</td>
                    <td>${course.classroom}</td>
                    <td>
                        <button class="btn btn-primary" style="margin-right: 5px;" onclick="openCourseEditModal('${course.id}')">编辑</button>
                        <button class="btn btn-danger" onclick="deleteCourse('${course.id}')">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        // 更新配置表单
        function updateConfigForm() {
            document.getElementById('config-school-name').value = config.schoolName || '';
            document.getElementById('config-semester').value = config.currentSemester || '';
        }

        // 加载课表网格
        function loadScheduleGrid() {
            const grid = document.getElementById('schedule-grid');
            grid.innerHTML = '';
            
            // 创建表头
            const headerCell = document.createElement('div');
            headerCell.className = 'schedule-cell schedule-header';
            headerCell.textContent = '时间/星期';
            grid.appendChild(headerCell);
            
            config.weekdays?.forEach(day => {
                const dayCell = document.createElement('div');
                dayCell.className = 'schedule-cell schedule-header';
                dayCell.textContent = day;
                grid.appendChild(dayCell);
            });
            
            // 创建时间段行
            config.timeSlots?.forEach(slot => {
                const timeCell = document.createElement('div');
                timeCell.className = 'schedule-cell schedule-header';
                timeCell.className = 'schedule-cell schedule-header schedule-time-header';
                timeCell.innerHTML = `${slot.name}<br><small>${slot.startTime}-${slot.endTime}</small>`;
                grid.appendChild(timeCell);
                
                for (let day = 1; day <= 7; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'schedule-cell';
                    
                    const courseSchedule = schedule.find(s => 
                        parseInt(s.day) === day && parseInt(s.timeSlot) === slot.id
                    );
                    
                    if (courseSchedule) {
                        const course = courses.find(c => c.id === courseSchedule.courseId);
                        if (course) {
                            cell.className += ' schedule-course';
                            cell.innerHTML = `${course.name}<br><small>${course.teacher}</small>`;
                        }
                    }
                    cell.onclick = () => openCourseModal(day, slot.id);
                    grid.appendChild(cell);
                }
            });
        }

        // 打开课程编辑/添加模态框
        let isEditingCourse = false;
        function openCourseEditModal(courseId = null) {
            const modal = document.getElementById('course-edit-modal');
            const form = document.getElementById('course-form');
            const title = document.getElementById('course-modal-title');
            const idInput = document.getElementById('course-id');

            form.reset();

            if (courseId) {
                // 编辑模式
                isEditingCourse = true;
                title.textContent = '编辑课程';
                const course = courses.find(c => c.id === courseId);
                if (course) {
                    idInput.value = course.id;
                    idInput.readOnly = true; // 禁止修改课程代码
                    document.getElementById('course-name').value = course.name;
                    document.getElementById('course-teacher').value = course.teacher;
                    document.getElementById('course-classroom').value = course.classroom;
                    document.getElementById('course-description').value = course.description;
                }
            } else {
                // 添加模式
                isEditingCourse = false;
                title.textContent = '添加新课程';
                idInput.readOnly = false;
            }

            modal.style.display = 'block';
        }

        function closeCourseEditModal() {
            document.getElementById('course-edit-modal').style.display = 'none';
        }

        // 保存课程（添加或更新）
        async function saveCourse(event) {
            event.preventDefault();
            
            const courseData = {
                id: document.getElementById('course-id').value,
                name: document.getElementById('course-name').value,
                teacher: document.getElementById('course-teacher').value,
                classroom: document.getElementById('course-classroom').value,
                description: document.getElementById('course-description').value
            };

            if (isEditingCourse) {
                // 更新现有课程
                const index = courses.findIndex(c => c.id === courseData.id);
                if (index !== -1) {
                    courses[index] = courseData;
                }
            } else {
                // 添加新课程，检查ID是否重复
                if (courses.some(c => c.id === courseData.id)) {
                    showAlert('课程代码已存在，请使用其他代码', 'error');
                    return;
                }
                courses.push(courseData);
            }
            
            try {
                const response = await fetch('./api/courses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ courses })
                });
                
                if (response.ok) {
                    showAlert(isEditingCourse ? '课程更新成功' : '课程添加成功');
                    closeCourseEditModal();
                    updateUI();
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                showAlert('保存课程失败', 'error');
            }
        }

        // 删除课程
        async function deleteCourse(courseId) {
            if (!confirm('确定要删除这门课程吗？')) return;
            
            courses = courses.filter(c => c.id !== courseId);
            
            try {
                const response = await fetch('./api/courses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ courses })
                });
                
                if (response.ok) {
                    showAlert('课程删除成功');
                    updateUI();
                } else {
                    throw new Error('删除失败');
                }
            } catch (error) {
                showAlert('删除课程失败', 'error');
            }
        }

        // 打开课程选择模态框
       let currentEditing = { day: null, timeSlot: null };
       function openCourseModal(day, timeSlot) {
           currentEditing = { day, timeSlot };
           
           const modal = document.getElementById('course-modal');
           const select = document.getElementById('modal-course-select');
           select.innerHTML = '<option value="">-- 选择课程 --</option>';
           
           courses.forEach(course => {
               const option = document.createElement('option');
               option.value = course.id;
               option.textContent = `${course.name} (${course.teacher})`;
               select.appendChild(option);
           });

           const existingSchedule = schedule.find(s => parseInt(s.day) === day && parseInt(s.timeSlot) === timeSlot);
           if (existingSchedule) {
               select.value = existingSchedule.courseId;
           } else {
               select.value = "";
           }
           
           modal.style.display = 'block';
       }

       function closeModal() {
           document.getElementById('course-modal').style.display = 'none';
       }

       async function saveScheduleChange() {
           const courseId = document.getElementById('modal-course-select').value;
           const { day, timeSlot } = currentEditing;

           // 移除旧的安排
           schedule = schedule.filter(s =>
               !(parseInt(s.day) === day && parseInt(s.timeSlot) === timeSlot)
           );

           // 如果选择了课程，则添加新的安排
           if (courseId) {
               schedule.push({
                   day: day.toString(),
                   timeSlot: timeSlot.toString(),
                   courseId: courseId,
                   week: "1-16" // 默认周次
               });
           }

           try {
               const response = await fetch('./api/schedule', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({ schedule })
               });

               if (response.ok) {
                   showAlert('课表更新成功');
                   closeModal();
                   loadScheduleGrid();
               } else {
                   throw new Error('更新失败');
               }
           } catch (error) {
               showAlert('更新课表失败', 'error');
           }
       }

       async function deleteCurrentSchedule() {
           const { day, timeSlot } = currentEditing;

           // 检查是否存在该日程
           const existingScheduleIndex = schedule.findIndex(s =>
               parseInt(s.day) === day && parseInt(s.timeSlot) === timeSlot
           );

           if (existingScheduleIndex === -1) {
               showAlert('该时间段没有课程安排，无需删除', 'error');
               return;
           }

           if (!confirm('确定要删除这个课程安排吗？')) return;

           // 移除该日程
           schedule.splice(existingScheduleIndex, 1);

           try {
               const response = await fetch('./api/schedule', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({ schedule })
               });

               if (response.ok) {
                   showAlert('课程安排删除成功');
                   closeModal();
                   loadScheduleGrid();
               } else {
                   throw new Error('删除失败');
               }
           } catch (error) {
               showAlert('删除课表失败', 'error');
           }
       }

        // 删除课表安排
        async function deleteSchedule(day, timeSlot) {
            if (!confirm('确定要删除这个课程安排吗？')) return;
            
            schedule = schedule.filter(s => 
                !(parseInt(s.day) === day && parseInt(s.timeSlot) === timeSlot)
            );
            
            try {
                // 调用后端API保存课表
                const response = await fetch('./api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule })
                });
                
                if (response.ok) {
                    showAlert('课程安排删除成功');
                    loadScheduleGrid();
                } else {
                    throw new Error('删除失败');
                }
            } catch (error) {
                showAlert('删除课表失败', 'error');
                console.error('删除课表失败:', error);
            }
        }

        // 保存配置
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            config.schoolName = document.getElementById('config-school-name').value;
            config.currentSemester = document.getElementById('config-semester').value;
            
            try {
                const response = await fetch('./api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showAlert('配置保存成功');
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                showAlert('保存配置失败', 'error');
            }
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', loadData);

        // 登出逻辑
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('./api/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = './login';
                } else {
                   throw new Error('Logout failed');
                }
            } catch (error) {
                showAlert('退出登录失败', 'error');
            }
        });
    </script>

   <!-- 课程选择模态框 -->
    <div id="course-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑课程安排</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modal-course-select">选择课程</label>
                    <select id="modal-course-select" class="form-group"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="btn btn-danger" onclick="deleteCurrentSchedule()">删除此项</button>
                <button class="btn btn-primary" onclick="saveScheduleChange()">保存更改</button>
            </div>
        </div>
    </div>

   <!-- 课程编辑/添加模态框 -->
    <div id="course-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="course-modal-title">添加新课程</h3>
                <span class="close-btn" onclick="closeCourseEditModal()">&times;</span>
            </div>
            <form id="course-form" onsubmit="saveCourse(event)">
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="course-id">课程代码</label>
                            <input type="text" id="course-id" required>
                        </div>
                        <div class="form-group">
                            <label for="course-name">课程名称</label>
                            <input type="text" id="course-name" required>
                        </div>
                        <div class="form-group">
                            <label for="course-teacher">授课教师</label>
                            <input type="text" id="course-teacher" required>
                        </div>
                        <div class="form-group">
                            <label for="course-classroom">教室</label>
                            <input type="text" id="course-classroom" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="course-description">课程描述</label>
                        <textarea id="course-description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" onclick="closeCourseEditModal()">取消</button>
                     <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>